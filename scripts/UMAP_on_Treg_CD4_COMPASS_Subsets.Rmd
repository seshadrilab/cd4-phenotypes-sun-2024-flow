---
title: "RSTR Dim Red on Treg CD4 COMPASS Subsets"
author: "Jolie Phan"
date: "version `r format(Sys.time(), '%B %d, %Y')`"
output:
  html_document:
    toc: yes
    toc_depth: 4
    toc_float:
      collapsed: no
  pdf_document:
    toc: yes
    toc_depth: 4
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Run UMAP on CD4+ events which express a COMPASS subset. 

# Load libraries

```{r, message=FALSE}
library(openCyto)
library(CytoML) 
library(flowCore) 
library(flowWorkspace) 
library(here)
library(tidyverse)
library(uwot)
library(ggplot2)
library(scales)
library(cowplot)
library(hues)
library(ggrepel)
library(ggpubr)
library(ggrastr)
source(here::here("scripts/Helper_Functions.R"))
```

# Load data

```{r}
# Date for "sampled" data
# date <- 20220713 

# Date for unsampled data
date <- 20220712
save_output <- FALSE
rerun_dimred <- FALSE
```

```{r, eval=FALSE}
gs <- load_gs(here::here("out/GatingSets/RSTR_Treg_GatingSet_with_COMPASS_Subsets"))

if(!dir.exists(here::here("out/UMAP"))) {
  cat(sprintf("Creating folder %s\n", here::here("out/UMAP")))
  dir.create(here::here("out/UMAP"), recursive = T)
}
```

# Extract mfi data

```{r}
cd4_gates_for_dimred <- c(
  "/Time/Cells/CD3+CD14-CD19-/Singlets/Live/CD3+ Lymphocytes/CD4+/CD154+",
  "/Time/Cells/CD3+CD14-CD19-/Singlets/Live/CD3+ Lymphocytes/CD4+/CD137+",
  "/Time/Cells/CD3+CD14-CD19-/Singlets/Live/CD3+ Lymphocytes/CD4+/CTLA4+",
  "/Time/Cells/CD3+CD14-CD19-/Singlets/Live/CD3+ Lymphocytes/CD4+/OX40+",
  "/Time/Cells/CD3+CD14-CD19-/Singlets/Live/CD3+ Lymphocytes/CD4+/CCR7+",
  "/Time/Cells/CD3+CD14-CD19-/Singlets/Live/CD3+ Lymphocytes/CD4+/IL10+",
  "/Time/Cells/CD3+CD14-CD19-/Singlets/Live/CD3+ Lymphocytes/CD4+/FOXP3+",
  "/Time/Cells/CD3+CD14-CD19-/Singlets/Live/CD3+ Lymphocytes/CD4+/CD25+",
  "/Time/Cells/CD3+CD14-CD19-/Singlets/Live/CD3+ Lymphocytes/CD4+/CD39+",
  "/Time/Cells/CD3+CD14-CD19-/Singlets/Live/CD3+ Lymphocytes/CD4+/CD73+"
  )

cd4_act_gates <- c(
  "/Time/Cells/CD3+CD14-CD19-/Singlets/Live/CD3+ Lymphocytes/CD4+/CD154+",
  "/Time/Cells/CD3+CD14-CD19-/Singlets/Live/CD3+ Lymphocytes/CD4+/CD137+",
  "/Time/Cells/CD3+CD14-CD19-/Singlets/Live/CD3+ Lymphocytes/CD4+/CTLA4+",
  "/Time/Cells/CD3+CD14-CD19-/Singlets/Live/CD3+ Lymphocytes/CD4+/OX40+"
  )
```

```{r}
# Get counts for CD4_COMPASS_Subsets
cd4_compass_subsets_parentGate <- "/Time/Cells/CD3+CD14-CD19-/Singlets/Live/CD3+ Lymphocytes/CD4+/CD4_COMPASS_Subsets"
```

```{r}
pop_counts <- pData(gs) %>%
  tibble::rownames_to_column("rowname") %>%
  left_join(gs_pop_get_count_fast(gs, subpopulations = cd4_compass_subsets_parentGate), by = c("rowname" = "name")) %>%
  dplyr::rename(CD4_COMPASS_Subsets = Count) %>%
  dplyr::select(rowname, "SAMPLE ID", "EXPERIMENT NAME", Stim, Status, CD4_COMPASS_Subsets) 

# Sample the data by "Stim"
cd4_umap_sample_sizes <- pop_counts %>% 
  group_by(Stim) %>% 
  nest() %>% 
  ungroup() %>% 
  mutate(nsamp = map2(5000, data, function(totalEvents, df) {
    distributeEvents(totalEvents, df$CD4_COMPASS_Subsets)
  })) %>% 
  unnest(cols = c(data, nsamp))

cd4_umap_sample_sizes %>% 
  group_by(Stim) %>% 
  summarise(nsamp_sum = sum(nsamp)) %>% 
  dplyr::pull(nsamp_sum) %>% 
  unique()
```

```{r}
# Extract data for dimensionality reduction 
# TO DO: Figure out why this isn't working 
call_sampleGatingHierarchy_for_cd4 <- function(currentSampleName, currentSampleSize) {
  sampleGatingHierarchy(gs[[currentSampleName]], cd4_compass_subsets_parentGate, n = currentSampleSize, otherGates = cd4_gates_for_dimred)
}

cd4_compass_subsets_data <- map_dfr(cd4_umap_sample_sizes$rowname, cd4_umap_sample_sizes$nsamp, call_sampleGatingHierarchy_for_cd4) 
dim(cd4_compass_subsets_data)
knitr::kable(head(cd4_compass_subsets_data))
```

# Perform Dimensionality Reduction

```{r}
cols_4_dimred <- c("CD3", "CD8a", "CD4", "CD154", "CD137", "CTLA4", "OX40", "CCR7", "IL10", "FOXP3", "CD25", "CD39", "CD73")
# Scale CD4 COMPASS subset counts 
cd4.scaled_dimred_input <- cd4_compass_subsets_data %>%
  dplyr::select("EXPERIMENT NAME", all_of(cols_4_dimred)) %>%
  group_by(`EXPERIMENT NAME`) %>%
  nest() %>%
  ungroup() %>%
  mutate(data = lapply(data, function(df) {as.data.frame(scale(as.matrix(df)))})) %>%
  unnest(cols = c(data)) %>%
  rename_at(vars(all_of(cols_4_dimred)),function(x) paste0(x,".scaled")) %>% 
  dplyr::select(-"EXPERIMENT NAME")

cd4_compass_subsets_data <- cbind(cd4_compass_subsets_data, cd4.scaled_dimred_input)
```

```{r}
# Running this without sampling took almost 2 hours!
if(rerun_dimred) {
  print("Running UMAP")
  set.seed(date)
  print(Sys.time())
  cd4_compass_subsets_dimred_out <- cd4_compass_subsets_data %>%
    # Run CD3, co-receptor, cytokine, memory, and activation markers through UMAP
    dplyr::select(all_of(paste0(cols_4_dimred, ".scaled"))) %>%
    uwot::umap(spread = 9, min_dist = 0.02, n_threads = 7)
  print(Sys.time())
  cd4_compass_subsets_w_umap <- cbind(as.data.frame(cd4_compass_subsets_dimred_out) %>%
    dplyr::rename(x.umap = V1, y.umap = V2),
  cd4_compass_subsets_data)
  if(save_output) {
    saveRDS(cd4_compass_subsets_w_umap, here::here(sprintf("out/UMAP/%s_Treg_CD4_COMPASS_Subsets_UMAP_Unsampled.rds", date)))
    }
} else {
  # Assuming UMAP results are already saved
  print("Loading saved UMAP run")
  cd4_compass_subsets_w_umap <- readRDS(here::here(sprintf("out/UMAP/%s_Treg_CD4_COMPASS_Subsets_UMAP_Unsampled.rds", date)))
}
```

# Plot UMAP results

```{r}
set.seed(date)
cd4_compass_subsets_w_umap <- cd4_compass_subsets_w_umap[sample(nrow(cd4_compass_subsets_w_umap), nrow(cd4_compass_subsets_w_umap)),]
```

```{r}
# Arial font setup. Downloaded afms from https://github.com/microsoft/microsoft-r-open/tree/ec3fd89e5fb5794bd8149905c134ad801bb61800
Arial <- Type1Font(family = "Arial",
                   metrics = c(here::here("data/Arial_afm/ArialMT.afm"),
                               here::here("data/Arial_afm/ArialMT-Bold.afm"), 
                              here::here("data/Arial_afm/ArialMT-Italic.afm"),                         
                              here::here("data/Arial_afm/ArialMT-BoldItalic.afm")))
windowsFonts("Arial" = windowsFont("Arial"))
pdfFonts(Arial = Arial)

boolColorScheme <- c("FALSE" = "#9E9E9E", "TRUE" = "#C7254A")

cd4_compass_subsets_w_umap <- cd4_compass_subsets_w_umap %>%
  mutate(dof = rowSums(dplyr::select(., all_of(cd4_act_gates))))

stim_labs <- c("DMSO", "PP1", "TB WCL")
names(stim_labs) <- c("DMSO", "PP1", "TB WCL")
group_labs <- c("Pneg", "TST+")
names(group_labs) <- c("Pneg", "TST+")

base_dimred_plot <- function(currentColumn, pointSize = 0.02, colorScheme = NA) {
  p <- ggplot(cd4_compass_subsets_w_umap, aes(x=x.umap, y=y.umap,
                                       colour=if(currentColumn %in% c("EXPERIMENT NAME", "SAMPLE ID")) {
                                         factor(!!as.name(currentColumn))
                                         } else {
                                           as.logical(!!as.name(currentColumn))
                                           })) +
    geom_point_rast(shape=20, alpha=0.8, size=pointSize) +
    facet_grid(Status ~ Stim, switch="y",
               labeller = labeller(Status = group_labs, Stim = stim_labs)) +
    theme_bw() +
    theme(plot.title=element_text(hjust = 0.5, size=22, face="bold"),
          axis.text=element_blank(),
          axis.line=element_blank(),
          axis.ticks=element_blank(),
          axis.title=element_blank(),
          strip.text=element_text(face="bold", size=10),
          panel.grid.major = element_blank(),
          legend.title=element_text(face="bold", size=14),
          strip.text.x = element_text(margin = margin(0.15,0,0.15,0, "cm")))
  if(!anyNA(colorScheme)) {
    p <- p + scale_color_manual(values = colorScheme)
  }
  if(currentColumn %in% c("EXPERIMENT NAME", "SAMPLE ID")) {
    p <- p + labs(color = currentColumn) +
      guides(colour = guide_legend(override.aes = list(size=7))) +
      theme(legend.title = element_text(size=10),
            legend.text = element_text(size=10),
            legend.position = "bottom") +
      scale_colour_manual(values=as.character(iwanthue(length(unique(cd4_compass_subsets_w_umap[,currentColumn])))))
  } else {
    p <- p + theme(legend.position = "none")
  }
  p
}
```

## Look for Batch and Patient sub-clustering

```{r, fig.width=10, fig.height=8}
base_dimred_plot("EXPERIMENT NAME")
```

```{r, fig.width=10, fig.height=8}
base_dimred_plot("SAMPLE ID")
```

## Individual marker expression localization

```{r, fig.width=10, fig.height=8}
for(cg in cd4_gates_for_dimred[1:6]) {
  print(base_dimred_plot(cg, colorScheme = boolColorScheme) +
    labs(title = sprintf("CD4 COMPASS Subset+ UMAP\nColored by %s", sub(".*\\/([^(\\/)]+)", "\\1", cg))))
}
```

# Unstratified UMAP plots

## Add categories 

```{r}
# Add Treg column
getTregCategory <- function(FOXP3, CD25) {
  if(FOXP3 & CD25) {
    "FoxP3+CD25+ (Treg)"
  } else if(FOXP3 & !CD25) {
    "FoxP3+CD25-"
  } else if(!FOXP3 & CD25) {
    "FoxP3-CD25+"
  } else if(!FOXP3 & !CD25) {
    "FoxP3-CD25-"
  } else {
    "Uncategorized"
  }
}
cd4_compass_subsets_w_umap$TregCategory <- pmap_chr(.l = list(cd4_compass_subsets_w_umap$`/Time/Cells/CD3+CD14-CD19-/Singlets/Live/CD3+ Lymphocytes/CD4+/FOXP3+`,
                                                              cd4_compass_subsets_w_umap$`/Time/Cells/CD3+CD14-CD19-/Singlets/Live/CD3+ Lymphocytes/CD4+/CD25+`),
                                                     .f = getTregCategory)
cd4_compass_subsets_w_umap$TregCategory <- factor(cd4_compass_subsets_w_umap$TregCategory, levels = c("FoxP3+CD25+ (Treg)", "FoxP3+CD25-", "FoxP3-CD25+", "FoxP3-CD25-"))

# Add CD39/CD73 column
getCD39_CD73Category <- function(CD39, CD73) {
  if(CD39 & CD73) {
    "CD39+CD73+"
  } else if(CD39 & !CD73) {
    "CD39+CD73-"
  } else if(!CD39 & CD73) {
    "CD39-CD73+"
  } else if(!CD39 & !CD73) {
    "CD39-CD73-"
  } else {
    "Uncategorized"
  }
}
cd4_compass_subsets_w_umap$CD39_CD73Category <- pmap_chr(.l = list(cd4_compass_subsets_w_umap$`/Time/Cells/CD3+CD14-CD19-/Singlets/Live/CD3+ Lymphocytes/CD4+/CD39+`,
                                                                   cd4_compass_subsets_w_umap$`/Time/Cells/CD3+CD14-CD19-/Singlets/Live/CD3+ Lymphocytes/CD4+/CD73+`),
                                                     .f = getCD39_CD73Category)
cd4_compass_subsets_w_umap$CD39_CD73Category <- factor(cd4_compass_subsets_w_umap$CD39_CD73Category, levels = c("CD39+CD73+", "CD39+CD73-", "CD39-CD73+", "CD39-CD73-"))
```

## Subset data

For now, only look at PP1

```{r}
pp1_data <- cd4_compass_subsets_w_umap %>%
  dplyr::filter(Stim == "PP1")
```

## Set ggplot settings

```{r}
pointSize <- 0.02
# gg_themes <- ggplot(cd4_compass_subsets_w_umap, aes(x=x.umap, y=y.umap)) +
#   scale_x_continuous(limits=range(cd4_compass_subsets_w_umap$x.umap)*1.16) +
#   scale_y_continuous(limits=range(cd4_compass_subsets_w_umap$y.umap)*1.11) +
#   theme_bw() +
#   theme(plot.title=element_text(hjust = 0.5, size=21),
#         axis.text=element_blank(),
#         axis.line=element_blank(),
#         axis.ticks=element_blank(),
#         axis.title=element_blank(),
#         panel.grid = element_blank(),
#         legend.position = "right",
#         legend.justification = "left",
#         legend.title.align = 0.5,
#         legend.text = element_text(size = 17, color = "black"),
#         legend.title = element_text(size = 20, color = "black"),
#         legend.spacing.x = unit(0.5, "cm"),
#         plot.margin = margin(1, 0, 0, 0, unit = "pt")) +
#   guides(colour = guide_legend(override.aes = list(size=12)))
pp1_themes <- ggplot(pp1_data, aes(x=x.umap, y=y.umap)) +
  scale_x_continuous(limits=range(pp1_data$x.umap)*1.16) +
  scale_y_continuous(limits=range(pp1_data$y.umap)*1.11) +
  theme_bw() +
  theme(plot.title=element_text(hjust = 0.5, size=21),
        axis.text=element_blank(),
        axis.line=element_blank(),
        axis.ticks=element_blank(),
        axis.title=element_blank(),
        panel.grid = element_blank(),
        legend.position = "right",
        legend.justification = "left",
        legend.title.align = 0.5,
        legend.text = element_text(size = 17, color = "black"),
        legend.title = element_text(size = 20, color = "black"),
        legend.spacing.x = unit(0.5, "cm"),
        plot.margin = margin(1, 0, 0, 0, unit = "pt")) +
  guides(colour = guide_legend(override.aes = list(size=12)))
```

## Color by status

```{r}
statusColorScheme <- c("Pneg" = "#984EA3", "TST+" = "#4DAF4A")
status_plot <- pp1_themes +
  geom_point_rast(aes(colour=pp1_data[,"Status"]), shape=20, alpha=0.8, size=pointSize) +
  scale_color_manual(values = statusColorScheme) +
  labs(colour = "Status") 

# status_titles <- c("Pneg" = "Pneg", "TST+" = "TST+")
# plot_status_contour_plot <- function(currentStatus) {
#   gg_themes +
#     geom_point_rast(shape=20, alpha=0.8, size=pointSize, colour="#E2E2E2") +
#     geom_density_2d(data=cd4_compass_subsets_w_umap %>% dplyr::filter(Status == currentStatus),
#                     colour="#363636", bins=12) + 
#     ggtitle(status_titles[[currentStatus]])
# }
# status <- c("Pneg", "TST+")
# status_plots <- lapply(status, plot_status_contour_plot)
# names(status_plots) <- status
# status_plots$Pneg
```

## Color by PolyF

Get plots.

```{r}
myPalette <- viridis_pal()
sc_polyf <- scale_colour_gradientn(colours = myPalette(100), limits=c(1, 5))
grid::current.viewport()
polyf_plot <- pp1_themes +
  geom_point_rast(aes(colour=pp1_data[,"dof"]), shape=20, alpha=0.8, size=pointSize) +
  sc_polyf +
  labs(colour = "PolyF") +
  guides(colour=guide_colorbar(title.position = "left")) +
  theme(legend.title = element_text(angle=90))
polyf_plot
```

## Visualize phenotypic/functional marker localization 

Set colors.

```{r}
pal <- viridis_pal()(20)

# FoxP3-CD25- is grey, FoxP3+CD25- is yellow, FoxP3-CD25+ is blue, and FoxP3+CD25+ is green
TregColorScheme <- c("FoxP3-CD25-" = "#999999", "FoxP3+CD25-" = pal[20], "FoxP3-CD25+" = pal[7], "FoxP3+CD25+ (Treg)" = pal[16]) 

# CD39-CD73- is grey, CD39+73- is yellow, CD39-CD73+ is blue, and CD39+CD73+ is green
CD39_CD73ColorScheme <- c("CD39-CD73-" = "#999999", "CD39+CD73-" = pal[20], "CD39-CD73+" = pal[7], "CD39+CD73+" = pal[16]) 
```

Get plots.

```{r}
treg_plot_colored_by_gate <- pp1_themes +
  geom_point_rast(aes(colour=pp1_data[,"TregCategory"]),
                  shape=20, alpha=0.8, size=pointSize) +
  scale_color_manual(values = TregColorScheme) +
  labs(colour = "Markers")

cd39_cd73_plot_colored_by_gate <- pp1_themes +
  geom_point_rast(aes(colour=pp1_data[,"CD39_CD73Category"]),
                  shape=20, alpha=0.8, size=pointSize) +
  scale_color_manual(values = CD39_CD73ColorScheme) +
  labs(colour = "Markers")
```

Organize plots to make their plot sizes consistent.

```{r}
umap_list <- align_plots(status_plot, treg_plot_colored_by_gate, cd39_cd73_plot_colored_by_gate, polyf_plot, align = "hv")
names(umap_list) <- c("status", "treg", "cd39_cd73", "polyf")
```

```{r, fig.width = 7, fig.height = 5}
ggdraw(umap_list[["status"]])
```

```{r, fig.width = 7, fig.height = 5}
ggdraw(umap_list[["treg"]])
```

```{r, fig.width = 7, fig.height = 5}
ggdraw(umap_list[["cd39_cd73"]])
```

```{r, fig.width = 7, fig.height = 5}
ggdraw(umap_list[["polyf"]])
```

# Save figs

```{r}
cairo_pdf(file=here::here("out/UMAP/Treg_CD4_umap_plots.pdf"), width=7, height=5,
          onefile = TRUE, bg = "transparent", family = "Arial") # default unit is inches, default font is Helvetica.
print(ggdraw(umap_list[["status"]]))
print(ggdraw(umap_list[["treg"]]))
print(ggdraw(umap_list[["cd39_cd73"]]))
print(ggdraw(umap_list[["polyf"]]))
dev.off()
```